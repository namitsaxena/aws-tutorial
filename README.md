## AWS CLI 
#### Configuration
* aws configure
* aws configure list
* aws configure get region

#### Current user
* aws sts get-caller-identity --output text 
* `aws sts get-caller-identity --output text --query Arn`

#### S3
* aws s3api list-buckets
* `aws s3api list-buckets --query "Buckets[].Name"`

#### Cloudformation
* Validate: `aws cloudformation validate-template --template-body file://cft-ec2-instances.json`
* Create: ` aws cloudformation create-stack --stack-name ns-ec2-instances --template-body file://cft-ec2-instances.json`
  * wait: `aws cloudformation wait stack-create-complete --stack-name ns-ec2-instances`
* Check Status: `aws cloudformation describe-stacks --stack-name ns-ec2-instances`
* Delete: `aws cloudformation delete-stack --stack-name ns-ec2-instances`
  * wait: `aws cloudformation wait stack-delete-complete --stack-name ns-ec2-instances`

#### EC2
* Create a key pair: The command below will create a keypair, and the private key will be displayed/saved locally in PEM format (the public key will be in AWS)
  * `aws ec2 create-key-pair --key-name admin_key_pair --query 'KeyMaterial' --output text > admin_key_pair.pem`
    * aws ec2 create-key-pair --key-name admin_key_pair ([reference](https://docs.aws.amazon.com/cli/latest/reference/ec2/create-key-pair.html))
  * aws ec2 describe-key-pairs --key-name admin_key_pair
  * To retrieve the public key 
    * chmod 400 admin_key_pair
    * ssh-keygen -y -f admin_key_pair.pem 
  * `aws ec2 delete-key-pair --key-name admin_key_pair`
  * [Amazon EC2 Key Pairs - Amazon Elastic Compute Cloud](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html#having-ec2-create-your-key-pair)
  * Keypair cannot be generated by cloud formation. It needs to be created in AWS or uploaded otherwise 
    * [Deploying private key pairs with AWS CloudFormation](https://binx.io/blog/2017/10/25/deploying-private-key-pairs-with-aws-cloudformation/)
* To launch an EC2 instance
  * Find an AMI type from console (or by running  a query) - ideally from free tier
    * `aws ec2 describe-images --owner amazon --filter "Name=architecture,Values=x86_64" "Name=description,Values=*Amazon Linux*2018.03*" "Name=image-type,Values=machine" "Name=virtualization-type,Values=hvm"`
  * Launch
    * `aws ec2 run-instances --image-id ami-035be7bafff33b6b6 --count 1 --instance-type t2.micro`
      * IF InvalidAMIID.NotFound) when calling the RunInstances operation: The image id '[ami-0b500ef59d8335eee]' does not exist
        * Most common cause is using image from a different region (make sure you are logged in the same region as your CLI)
    * Created with default VPC, security groups. Can be verified using:
      *  awless list vpcs
      * awless list securitygroups (also see below)
      * awless list subnets (by default 6 are available)
  * Terminate
    * `aws ec2 terminate-instances --instance-ids i-02fa4edd843531814`

#### Security Group
* aws ec2 describe-security-groups --group-names default
* Default Security Group
  * Allows all inbound traffic from other instances associated with the default security group. Rule:
    * | Inbound     | [sg-d10024a7](any)         | (Where sg-d10024a7 is the id of the default SG itself)
      * Allows all outbound traffic
      * So by default no ssh access will be allowed
* Creating a Security Group to allow SSH access (you can also modify/add a rule to the default)
  * Easiest is to add a rule to the default security group. 
  * Security groups are associated with network interfaces. After you launch an instance into a VPC, you can change the security groups that are associated with the instance. You can change the security groups for an instance when the instance is in the running or stopped state
  * Describe instances will show the security group associated with it (under network interfaces)
    * [AWS - Changing Group Membership](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#SG_Changing_Group_Membership)
      * As such just creating a new SG within a VPC is not sufficient
      * [Create, Configure, and Delete Security Groups for Amazon EC2](https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-sg.html)
        * `aws ec2 create-security-group --group-name MySecurityGroup --description "NS Security Group to allow ssh access" --vpc-id vpc-7547d30e`
          * Get VPC id from the default VPC or default security group 
          * Adding a rule to allow inbound SSH access
            * Get your IP address: curl https://checkip.amazonaws.com
            * `aws ec2 authorize-security-group-ingress --group-id sg-07916e35cfe25dce6 --protocol tcp --port 22 --cidr 73.210.107.5/24`
              * CIDR /24 specified a range(last 8 bits can be anything), /32 would have been only that ip address
              * Adding rule to my security group did not work. Had to be added to ‘default’ security group
      * `ssh -i ./admin_key_pair.pem ec2-user@ec2-35-175-228-166.compute-1.amazonaws.com`
        * with user ‘admin’ - did NOT work: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
        * with root: Please login as the user "ec2-user" rather than the user "root".
        * [Troubleshoot Connecting to EC2 Linux Instance Through SSH](https://aws.amazon.com/premiumsupport/knowledge-center/ec2-linux-ssh-troubleshooting/)
        * [Why are there separate security groups for vpc and ec2 on AWS? - Quora](https://www.quora.com/Why-are-there-separate-security-groups-for-vpc-and-ec2-on-AWS)
* Start a Web Server on one of the Instances
  * [What is Amazon Elastic Load Balancer (ELB) – Hacker Noon](https://hackernoon.com/what-is-amazon-elastic-load-balancer-elb-16cdcedbd485)
  ```bash
	sudo yum update -y
	sudo yum install -y httpd
	sudo service httpd start
	sudo chkconfig httpd on
	cd /var/www/html
	sudo su
	echo "This is the Main Website" > index.html
  ```	
  * You will need to open all ports or at least 80 from your ip
  ```bash
	curl 54.198.41.180:80
    This is the Main Website
  ```    
* List Instances
  * `aws ec2 describe-instances --filter "Name=instance-state-name,Values=running"`

#### ELB: [Tutorial: Create an Application Load Balancer Using the AWS CLI](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/tutorial-application-load-balancer-cli.html)
* Create Application Load Balancer
  * Create: `aws elbv2 create-load-balancer --name ns-load-balancer --subnets subnet-c97e47e6 subnet-c8dc1f82 --security-groups sg-d10024a7`
    * use subnets from 1a and 1b availability zones since that's where our instances are, and the default security groups
  * describe: `aws elbv2 describe-load-balancers --names my-load-balancer`
  * delete: aws elbv2 delete-load-balancer --load-balancer-arn arn:aws:elasticloadbalancing:us-east-1:304958422732:loadbalancer/app/NSAppLoadBalancer/4211fa60f5a5ccbd
* Create target groups
  * `aws elbv2 create-target-group --name ns-targets --protocol HTTP --port 80 --vpc-id vpc-7547d30e`
  * `aws elbv2 delete-target-group --target-group-arn arn:aws:elasticloadbalancing:us-east-1:304958422732:targetgroup/ns-targets/b6116ccdfa8b03f1`
* Register target groups to the load balancer
  * `aws elbv2 register-targets --target-group-arn arn:aws:elasticloadbalancing:us-east-1:304958422732:targetgroup/ns-targets/b6116ccdfa8b03f1 --targets Id=i-0ed67089ee018a6cc Id=i-0f21609d0e3c41c7b`
* Create Listener
  * `aws elbv2 create-listener --load-balancer-arn arn:aws:elasticloadbalancing:us-east-1:304958422732:loadbalancer/app/ns-load-balancer/d73bedeba943a2ae --protocol HTTP --port 80  --default-actions Type=forward,TargetGroupArn=arn:aws:elasticloadbalancing:us-east-1:304958422732:targetgroup/ns-targets/b6116ccdfa8b03f1`  
* Check Health
  `aws elbv2 describe-target-health --target-group-arn arn:aws:elasticloadbalancing:us-east-1:304958422732:targetgroup/ns-targets/b6116ccdfa8b03f1` 









